<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="caribou-datepicker-custom-icons.html">



<dom-module id="caribou-month">
    <template>
        <style>
            :host {
                display: block;
                overflow: hidden;
                width: 100%;
            }

            :host([hidden]) {
                display: none;
            }

            ul {
                list-style-type: none;
            }

            body {
                font-family: Verdana, sans-serif;
            }

            .weekdays {
                margin: 0;
                padding: 10px 0;
                background-color: #ffffff;
            }

            .weekdays li {
                display: inline-block;
                width: 13%;
                color: #bfbfbf;
                text-align: center;
            }

            /* Days (1-31) */

            .days {
                padding: 0;
                background: #ffffff;
                margin: 0;
            }

            .days li {
                list-style-type: none;
                display: inline-block;
                width: 13%;
                text-align: center;
                margin-bottom: 5px;
                font-size: 12px;
                color: #777;
            }

            /* Highlight the "current" day */

            .days li .active {
                color: #009688 !important;
                font-weight: 500;
            }

            .days li .selected {
                background: #009688;
                color: white !important;
                border-radius: 50px;
            }

            .days li span {
                width: 25px;
                height: 25px;
                padding: 5px;
                line-height: 25px;
            }

            paper-button.day {
                padding: 2px;
                --paper-button: {
                    border-radius: 25px;
                    width: 25px;
                    line-height: 25px;
                }
            }

            #monthNav {
                @apply --layout-horizontal;
            }

            #monthNav #monthNavValue {
                font-size: 14px;
                font-weight: 500;
                text-transform: capitalize;
                text-align: center;
                line-height: 3;
                @apply --layout-flex;
            }
        </style>



        <div id="monthNav">
            <paper-icon-button class="prev" icon="caribou-datepicker-icons:chevron-left" on-tap="previousMonth"></paper-icon-button>

            <div id="monthNavValue">{{getMonthValue(monthTemp,false)}} {{yearTemp}}</div>

            <paper-icon-button class="next" icon="caribou-datepicker-icons:chevron-right" on-tap="nextMonth"></paper-icon-button>
        </div>

        <ul class="weekdays" id="weekDays">
            <li>Su</li>
            <li>Mo</li>
            <li>Tu</li>
            <li>We</li>
            <li>Th</li>
            <li>Fr</li>
            <li>Sa</li>
        </ul>

        <ul class="days" id="days">
            <template is="dom-repeat" items="{{_getArrayOfDays(monthTemp,yearTemp,dateTemp)}}">
                <li>
                    <paper-button hidden$="{{!item.isValid}}" noink class="day" on-tap="_dateSelected" data-dday$="{{item.value}}">
                        <span id="date{{item.value}}" class$="{{_getClassDate(item.isCurrentDay, item.value)}}">{{item.value}}</span>
                    </paper-button>
                </li>
            </template>
        </ul>
    </template>

    <script>
        /**
         * `caribou-datepicker`
         * Polymer 2 element used to select a date picker following material design.
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class CaribouMonthElement extends Polymer.Element {
            static get is() {
                return 'caribou-month';
            }

            static get properties() {
                return {

                    hidden: {
                        type: Boolean,
                        value: false
                    },

                    /**
                     * Actual year selected by the user
                     */
                    year: {
                        type: Number,
                        notify: true,
                        observer: "yearChanged"
                    },

                    /**
                     * Actual month selected by the user
                     */
                    month: {
                        type: Number,
                        notify: true,
                        observer: "monthChanged"
                    },
                    /**
                     * Actual date selected by the user
                     */
                    date: {
                        type: Number,
                        notify: true,
                        observer: "dateChanged"
                    },

                    /**
                     * Sunday is 0 and monday is 1.
                     * This is the number of the day currently selected by the user
                     */
                    day: {
                        type: Number,
                        notify: true,
                        observer: "dayChanged"
                    },

                    /**
                     * This is the current year of the computer
                     */
                    currentYear: Number,

                    /**
                     * This is the current month of the computer
                     */
                    currentMonth: Number,

                    /**
                     * This is the current date of the computer
                     */
                    currentDate: Number,

                    /**
                     * Sunday is 0 and monday is 1.
                     * This is the number of the current day
                     * This is the current day of the computer
                     */
                    currentDay: Number,

                    /**
                     * This is the temporary year use for the navigation
                     */
                    yearTemp: {
                        type: Number,
                        notify: true
                    },

                    /**
                     * This is the temporary month use for the navigation
                     */
                    monthTemp: Number,

                    /**
                     * This is the temporary date use for the navigation
                     */
                    dateTemp: Number,

                    /**
                     * This is the temporary day use for the navigation
                     */
                    dayTemp: Number,

                    __daysValue: {
                        type: Array,
                        value: function () {
                            return [{
                                    max: "Sunday",
                                    min: "Sun"
                                },
                                {
                                    max: "Monday",
                                    min: "Mon"
                                },
                                {
                                    max: "Tuesday",
                                    min: "Tue"
                                },
                                {
                                    max: "Wednesday",
                                    min: "Wed"
                                },
                                {
                                    max: "Thursday",
                                    min: "Thu"
                                },
                                {
                                    max: "Friday",
                                    min: "Fri"
                                },
                                {
                                    max: "Saturday",
                                    min: "Sat"
                                }
                            ];
                        },
                        readOnly: true
                    },

                    __monthsValue: {
                        type: Array,
                        value: function () {
                            return [{
                                    max: "January",
                                    min: "Jan"
                                },
                                {
                                    max: "February",
                                    min: "Feb"
                                },
                                {
                                    max: "March",
                                    min: "Mar"
                                },
                                {
                                    max: "April",
                                    min: "Apr"
                                },
                                {
                                    max: "May",
                                    min: "May"
                                },
                                {
                                    max: "June",
                                    min: "Jun"
                                },
                                {
                                    max: "July",
                                    min: "Jul"
                                },
                                {
                                    max: "August",
                                    min: "Aug"
                                },
                                {
                                    max: "September",
                                    min: "Sep"
                                },
                                {
                                    max: "October",
                                    min: "Oct"
                                },
                                {
                                    max: "November",
                                    min: "Nov"
                                },
                                {
                                    max: "December",
                                    min: "Dec"
                                }
                            ];
                        },
                        readOnly: true
                    },

                    showYear: {
                        type: Boolean,
                        value: false
                    }
                };
            }

            ready() {
                super.ready();
            }

            /**
             * Observer called when the date value changed.
             * The selected date will be flaged with the css value selected.
             * And the old date value will be removed the selected css property.
             */
            dateChanged(date, oldDate) {
                //this is used to update the temp value when the input change.
                this.dateTemp = date;

                //We do the changes for the selection.
                var newEl = this.shadowRoot.querySelector("#date" + date);
                var oldEl = this.shadowRoot.querySelector("#date" + oldDate);
                if (oldEl !== null)
                    oldEl.classList.remove("selected");
                if (newEl !== null)
                    newEl.classList.add("selected");
            }

            /**
             * Observer called when the year value changed.
             * This will update the temp value and the overlay view
             */
            yearChanged(year) {
                this.yearTemp = year;
            }

            /**
             * Observer called when the month value changed.
             * This will update the temp value and the overlay view
             */
            monthChanged(month) {
                this.monthTemp = month;
            }

            /**
             * Observer called when the month value changed.
             * This will update the temp value and the overlay view
             */
            dayChanged(day) {
                this.dayTemp = day;
            }

            /**
             * Initialize the properties with the current date time.
             */
            getCurrentDate() {
                var today = new Date();
                this.setDateValues(today.getDay(), today.getDate(), today.getMonth() + 1, today.getFullYear());
            }

            /**
             * This function is used to set the current date.
             * This is used to intialize all the date parameter.
             * @param {Number} day The number of the day of the week
             * @param {Number} date The number of the day
             * @param {Number} month The number of the month
             * @param {Number} year The number of the year
             */
            setDate(day, date, month, year) {
                //day
                this.currentDay = day;
                this.day = this.currentDay;
                // this.dayTemp = this.currentDay;

                //month
                this.currentMonth = month;
                this.month = this.currentMonth;
                // this.monthTemp = this.currentMonth + 1;

                //year
                this.currentYear = year;
                this.year = this.currentYear;
                this.yearTemp = this.currentYear;

                //date
                this.currentDate = date;
                this.date = this.currentDate;
                // this.dateTemp = this.currentDate;
            }

            /**
             * Return the day value of the current number.
             * @param {Number} day This is the number of the day. (0-6)
             * @param {Boolean} minValue True if we want the min value, false otherwise.
             * @return {String} The day value.
             */
            getDayValue(day, minValue) {
                return minValue ? this.__daysValue[day].min : this.__daysValue[day].max;
            }

            /** 
             * Return the month value of the current number. 
             * @param {Number} day This is the number of the month. (1 to 12)
             * @param {Boolean} minValue True if we want the min value, false otherwise.
             * @return {String} The month value. 
             */
            getMonthValue(month, minValue) {
                return minValue ? this.__monthsValue[month - 1].min : this.__monthsValue[month - 1].max;
            }

            /**
             * Return the number of day in a month
             * @param {Number} month The month number
             * @param {Number} year The year number
             * @return {Number} The number of day in a month
             */
            getNumberOfDaysInMonth(month, year) {
                return new Date(year, month, 0).getDate();
            }

            getDayNumber(year, month, date) {
                try {
                    return new Date(year, month - 1, date).getDay();
                } catch (err) {
                    console.log(err);
                }
            }

            /**
             * Return the number of the first day in the month
             * @param {Number} month The month number
             * @param {Number} year The year number
             * @return {Number} An array of integer, the length is the number of the day in the month
             */
            getFirstMonthDay(month, year) {
                return new Date(year, month - 1, 1).getDay();
            }

            _getArrayOfDays(month, year, date) {
                if (month !== undefined && year !== undefined && date != undefined) {
                    let daysInMonth;
                    let firstDayOfWeek;
                    let daysArray = new Array();
                    if (month !== undefined && year !== undefined) {
                        // Get the first day of the week.
                        // We do -1 because we will use it 0 base.
                        firstDayOfWeek = this.getFirstMonthDay(month, year);
                        // Get the number of days in the month
                        daysInMonth = this.getNumberOfDaysInMonth(month, year);

                        //day number increment
                        let j = 0

                        for (var i = firstDayOfWeek; i < daysInMonth + firstDayOfWeek; i++) {
                            j = j + 1;
                            let isCurrentDay = false;
                            if (this.currentMonth === month && this.currentYear === year && this.currentDate ===
                                j) {
                                isCurrentDay = true;
                            }

                            daysArray[i] = {
                                value: j,
                                isCurrentDay: isCurrentDay,
                                isValid: true
                            };
                        }

                        for (var i = 0; i < firstDayOfWeek; i++) {
                            daysArray[i] = {
                                isValid: false
                            };
                        }

                        return daysArray;
                    }
                }
            }

            _getClassDate(isCurrentDay, dateValue) {
                if (isCurrentDay && (dateValue === this.date && this.month === this.monthTemp && this.year ===
                        this.yearTemp))
                    return "active selected";
                else if (isCurrentDay)
                    return "active"
                else if (dateValue === this.date && this.month === this.monthTemp && this.year === this
                    .yearTemp)
                    return "selected"
            }

            _getClassYear(isCurrentYear, isActiveYear) {
                if (isActiveYear) return "active";
                if (isCurrentYear) return "current";
            }

            previousMonth() {
                var prevMonth = new Date(this.yearTemp, this.monthTemp - 1, 1);

                // this.month = prevMonth.getMonth() === 0 ? 12 : prevMonth.getMonth();
                this.monthTemp = prevMonth.getMonth() === 0 ? 12 : prevMonth.getMonth();
                if (this.monthTemp === 12)
                    this.yearTemp = prevMonth.getFullYear() - 1;
                else
                    this.yearTemp = prevMonth.getFullYear();
            }

            nextMonth() {
                var nextMonth = new Date(this.yearTemp, this.monthTemp, 1);

                this.monthTemp = nextMonth.getMonth() + 1;
                this.yearTemp = nextMonth.getFullYear();

            }

            // _toggleYearView() {
            //     this.dispatchEvent(new CustomEvent('display-year-view', {
            //         bubbles: true,
            //         composed: true
            //     }));
            // }

            /**
             * This function is called when a date is selected to set the selected parameter.
             */
            _dateSelected(e) {
                // This is important to set the this.date at the end because there is value binded to it,
                // that need that the other values are set.
                var date = Number(e.currentTarget.dataset.dday);
                this.month = this.monthTemp;
                this.year = this.yearTemp;
                this.day = this.getDayNumber(this.year, this.month, date);
                this.date = date;

                this.dispatchEvent(new CustomEvent('date-selected', {
                    detail: {
                        date: this.date,
                        month: this.month,
                        year: this.year
                    },
                    bubbles: true,
                    composed: true
                }));
                console.log("caribou-month", "Date selected : " + this.date + " / " + (Number(this.month) + 1) +
                    " / " +
                    this.year);
            }
        }

        window.customElements.define(CaribouMonthElement.is, CaribouMonthElement);
    </script>
</dom-module>