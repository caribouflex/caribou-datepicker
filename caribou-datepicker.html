<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-dropdown/iron-dropdown.html">
<link rel="import" href="caribou-date-input.html">
<link rel="import" href="caribou-datepicker-custom-icons.html">
<link rel="import" href="caribou-datepicker-overlay.html">

<dom-module id="caribou-datepicker">
  <template>
    <style>
      :host {
        display: block;
      }

      [slot=dropdown-content] {
        border-radius: 3px;
        box-shadow: 0px 2px 6px #ccc;
      }
    </style>

    <paper-input-container id="inputContainer" always-float-label attr-for-value="value" invalid="[[invalid]]">
      <label slot="label">{{inputLabel}}</label>
      <caribou-date-input class="paper-input-input" slot="input" invalid-date="{{invalid}}" date-d="{{date}}" date-m="{{month}}"
        date-y="{{year}}" format="[[dateFormat]]"></caribou-date-input>
      <paper-icon-button id="calendarIcon" slot="suffix" on-tap="open" icon="caribou-datepicker-icons:calendar"></paper-icon-button>
      <paper-input-error slot="add-on">{{inputError}}</paper-input-error>
    </paper-input-container>

    <iron-dropdown id="dropdown">
      <div slot="dropdown-content">
        <caribou-datepicker-overlay id="datepickerOverlay" horizontal="[[horizontal]]" date="[[date]]" month="[[month]]" year="[[year]]"></caribou-datepicker-overlay>
      </div>
    </iron-dropdown>

  </template>

  <script>
    /**
     * `caribou-datepicker`
     * Polymer 2 element used to select a date picker following material design.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class CaribouDatepicker extends Polymer.Element {
      // class CaribouDatepicker extends Polymer.Element {
      static get is() {
        return 'caribou-datepicker';
      }

      static get properties() {
        return {
          inputLabel: {
            type: String,
            value: "Date"
          },

          inputError: {
            type: String,
            value: "Invalid date"
          },

          invalid: {
            type: Boolean,
            value: false
          },

          date: Number,
          month: Number,
          year: Number,

          closePickerOnDateSelection: {
            type: Boolean,
            value: false
          },

          setInputOnDateSelection: {
            type: Boolean,
            value: false
          },

          /**
           * This is the format of the date for the input.
           * Possible values : 
           *  - DMY
           *  - YMD
           *  - MDY
           */
          dateFormat: {
            type: String,
            value: "DMY",
            notify: true
          },

          horizontal: {
            type: Boolean,
            value: false
          }
        }
      }

      ready() {
        super.ready();
        this.$.datepickerOverlay.addEventListener("date-selected", this._setDateInput.bind(this));
        this.$.datepickerOverlay.addEventListener("ok-selected", this._setDateInput.bind(this));
        this.$.datepickerOverlay.addEventListener("close-overlay", this.closeOverlay.bind(this));
      }

      open() {
        this.$.dropdown.open();
      }

      _setDateInput(e) {

        if (e.type == "date-selected" && !this.closePickerOnDateSelection && !this.setInputOnDateSelection)
          return;

        this.date = e.detail.date;
        this.month = e.detail.month;
        this.year = e.detail.year;

        if (e.type == "date-selected" && !this.closePickerOnDateSelection)
          return;

        this.closeOverlay();
      }

      closeOverlay() {
        this.$.dropdown.close();
      }
    }

    window.customElements.define(CaribouDatepicker.is, CaribouDatepicker);
  </script>
</dom-module>