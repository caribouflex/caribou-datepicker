<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="caribou-year">
    <template>
        <style>
            :host {
                display: block;
                overflow-y: auto;
                height: 394px;
                /*Padding added to hide the scrollbar*/
                padding-right: 20px;
                width: 100%;
            }

            :host([hidden]) {
                display: none;
            }

            .years {
                @apply --layout-vertical;
            }

            .years paper-button {
                font-size: 15px;
            }

            .years paper-button .current {
                padding: 5px;
                color: #009688;
                font-size: 25px;
            }

            .iconBtnNav {
                margin: auto;
            }
        </style>

        <div id="years" class="years">
            <template is="dom-repeat" items="{{years}}">
                <paper-button data-year$="{{item.value}}" on-tap="_yearSelected">
                    <span class$="{{_getClassYear(item.isCurrentYear)}}">{{item.value}}</span>
                </paper-button>
            </template>
        </div>
    </template>

    <script>
        /**
         * `caribou-datepicker`
         * Polymer 2 element used to select a date picker following material design.
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class CaribouYearElement extends Polymer.Element {
            static get is() {
                return 'caribou-year';
            }

            static get properties() {
                return {
                    year: {
                        type: Number
                    },

                    currentYear: {
                        type: Number
                    },

                    years: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    },

                    init: {
                        type: Array,
                        value: false
                    },

                    lastYear: {
                        type: Number
                    },

                    firstYear: {
                        type: Number
                    }
                };
            }

            ready() {
                super.ready();

                this.$.years.addEventListener("mousewheel", this._mouseYearNav.bind(this));

                // console.log('caribou-year', "SET YEAR BUILT IN");
                // this.year = 2018;
            }

            setYear(year) {
                this.currentYear = year;
                this.year = year;
                this.lastYear = year;
                this.initYearArray();
            }

            /** 
             * clear years array and re-complete calling the functions.
             */
            initYearArray() {
                this.splice("years", 0, this.years.length);
                this.init = false;
                this._createYears();
            }

            /**
             * This function is used to intialize the array.
             * We will check the init property, if it's false that means the array has been already initialized.
             * Otherwise we add 4 year before the current one.
             * @private
             */
            _createYears() {
                if (this.lastYear === undefined)
                    this.lastYear = this.year;

                if (!this.init) {
                    this.push('years', this._getYearObject(Number(this.lastYear - 3)));
                    this.push('years', this._getYearObject(Number(this.lastYear - 2)));
                    this.push('years', this._getYearObject(Number(this.lastYear - 1)));
                    this.push('years', this._getYearObject(Number(this.lastYear)));
                    this.init = true;
                }

                for (var i = 0; i < 10; i++) {
                    this.lastYear = this.lastYear + 1;
                    this.push('years', this._getYearObject(Number(this.lastYear)));
                }
            }

            _getPreviousYears() {
                if (this.firstYear === undefined)
                    this.firstYear = this.year - 3;

                for (var i = 0; i < 10; i++) {
                    this.firstYear = this.firstYear - 1;
                    this.splice("years", 0, 0, this._getYearObject(Number(this.firstYear)));
                }

                this.scrollTop = 600;
            }

            _getYearObject(year) {
                let isCurrentYear = false;
                if (this.currentYear === year)
                    isCurrentYear = true;

                return {
                    value: year,
                    isCurrentYear: isCurrentYear
                };
            }

            _getClassYear(isCurrentYear) {
                if (isCurrentYear) return "current";
            }

            _mouseYearNav(e) {
                //e.wheelDelta >= 0  go to top otherwise go to bottom
                if (e.wheelDelta >= 0 && this.scrollTop === 0) {
                    this._getPreviousYears();
                } else if (this.scrollTop + this.clientHeight >= this.scrollHeight) {
                    this._createYears();
                }
            }

            _yearSelected(e) {
                //set the last year as the year selected before redraw the array
                this.setYear(Number(e.currentTarget.dataset.year));

                console.log("caribou-year", "Year selected : " + this.year);

                //The scroll year view has to be set to the top
                this.scrollTop = 0;

                // The event has to be sent after the scrollTop otherwise the scroll will never happened
                // because the view would have switched.
                this.dispatchEvent(new CustomEvent('year-selected', {
                    bubbles: true,
                    composed: true,
                    detail: {
                        year: e.currentTarget.dataset.year
                    }
                }));
            }
        }

        window.customElements.define(CaribouYearElement.is, CaribouYearElement);
    </script>
</dom-module>